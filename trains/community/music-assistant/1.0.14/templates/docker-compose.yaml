{% from "macros/config.sh.jinja" import config_script %}
{% set tpl = ix_lib.base.render.Render(values) %}

{% set c1 = tpl.add_container(values.consts.music_assistant_container_name, "image") %}
{% set config = tpl.add_container(values.consts.config_container_name, "yq_image") %}

{% do config.set_user(0, 0) %}
{% do config.setup_as_helper() %}
{% do config.configs.add("config.sh", config_script(values), "/config.sh", "0755") %}
{% do config.set_entrypoint(["/config.sh"]) %}
{% do config.add_storage("/data", values.storage.data) %}

{% do c1.set_user(0, 0) %}
{% do c1.healthcheck.set_test("wget", {"port": values.network.web_port.port_number, "path": "/info", "spider": false}) %}
{% do c1.depends.add_dependency(values.consts.config_container_name, "service_completed_successfully") %}
{% do c1.environment.add_user_envs(values.music_assistant.additional_envs) %}

{% do c1.add_port(values.network.web_port) %}
{% do c1.add_port(values.network.stream_port) %}

{% do c1.add_storage("/data", values.storage.data) %}

{% for store in values.storage.additional_storage %}
  {% do c1.add_storage(store.mount_path, store) %}
{% endfor %}

{% do tpl.portals.add(values.network.web_port) %}

{{ tpl.render() | tojson }}
