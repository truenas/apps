{% import "macros/config.sh" as config_macro %}

{% set tpl = ix_lib.base.render.Render(values) %}

{% if values.invidious.postgres_image_selector == "postgres_15_image" %}
  {% do tpl.notes.add_deprecation("Postgres 15 is deprecated and will be removed in the near future. Please upgrade.") %}
{% endif %}

{% set companion = tpl.add_container(values.consts.companion_container_name, "companion_image") %}
{% set c1 = tpl.add_container(values.consts.invidious_container_name, "image") %}
{% set db_fetch = tpl.add_container(values.consts.db_seed_fetch_container_name, "git_image") %}
{% set db_seed = tpl.add_container(values.consts.db_seed_apply_container_name, values.invidious.postgres_image_selector) %}
{% set config = tpl.add_container(values.consts.config_container_name, "yq_image") %}
{% set perm_container = tpl.deps.perms(values.consts.perms_container_name) %}

{% set pg_config = {
  "user": values.consts.db_user,
  "password": values.invidious.db_password,
  "database": values.consts.db_name,
  "volume": values.storage.postgres_data,
} %}
{% set postgres = tpl.deps.postgres(
  values.consts.postgres_container_name,
  values.invidious.postgres_image_selector,
  pg_config, perm_container
) %}

{% set perms_config = {"uid": values.consts.run_as_user, "gid": values.consts.run_as_group} %}

{% do c1.set_user(values.consts.run_as_user, values.consts.run_as_group) %}
{% do c1.healthcheck.set_test("netcat", {"port": values.network.web_port.port_number}) %}
{% do c1.environment.add_env("INVIDIOUS_CONFIG_FILE", "%s/config.yaml"|format(values.consts.config_path)) %}
{% do c1.environment.add_user_envs(values.invidious.additional_envs) %}

{% do c1.depends.add_dependency(values.consts.postgres_container_name, "service_healthy") %}
{% do c1.depends.add_dependency(values.consts.config_container_name, "service_completed_successfully") %}

{% do c1.add_port(values.network.web_port) %}

{% do companion.set_user(values.consts.inv_companion_run_as_user, values.consts.inv_companion_run_as_group) %}
{% do companion.environment.add_env("PORT", values.consts.inv_companion_port) %}
{% do companion.environment.add_env("SERVER_SECRET_KEY", values.invidious.companion_key) %}
{% do companion.set_read_only(true) %}
{% if values.ci %}
  {# It tries to reach to youtube and fetch token, which seems to not be possible in GHA #}
  {% do companion.healthcheck.disable() %}
{% else %}
  {% do companion.healthcheck.set_custom_test(["CMD", "/thc"]) %}
{% endif %}
{% do companion.add_storage("/var/tmp/youtubei.js", values.storage.companion_cache) %}
{% set companion_perms_config = {"uid": values.consts.inv_companion_run_as_user, "gid": values.consts.inv_companion_run_as_group} %}
{% do perm_container.add_or_skip_action("companion", values.storage.companion_cache, companion_perms_config) %}

{% do db_fetch.set_user(values.consts.run_as_user, values.consts.run_as_group) %}
{% do db_fetch.setup_as_helper() %}
{% do db_fetch.configs.add("fetch_db_seed.sh", config_macro.fetch_db_seed(values=values), "/fetch_db_seed.sh", "0755") %}
{% do db_fetch.set_entrypoint(["/fetch_db_seed.sh"]) %}

{% do db_seed.set_user(values.consts.run_as_user, values.consts.run_as_group) %}
{% do db_seed.setup_as_helper() %}
{% do db_seed.configs.add("apply_db_seed.sh", config_macro.apply_db_seed(values=values), "/apply_db_seed.sh", "0755") %}
{% do db_seed.set_entrypoint(["/apply_db_seed.sh"]) %}
{% do db_seed.depends.add_dependency(values.consts.postgres_container_name, "service_healthy") %}
{% do db_seed.depends.add_dependency(values.consts.db_seed_fetch_container_name, "service_completed_successfully") %}
{% do db_seed.environment.add_env("POSTGRES_USER", values.consts.db_user) %}
{% do db_seed.environment.add_env("POSTGRES_DB", values.consts.db_name) %}
{% do db_seed.environment.add_env("PGPASSWORD", values.invidious.db_password) %}
{% do db_seed.environment.add_env("PGHOST", values.consts.postgres_container_name) %}
{% do db_seed.environment.add_env("PGPORT", 5432) %}

{% set cfg = namespace(x=[
  {"check_tables": true},
  {"database_url": postgres.get_url("postgres")},
  {"db.user": values.consts.db_user},
  {"db.password": values.invidious.db_password},
  {"db.dbname": values.consts.db_name},
  {"db.host": values.consts.postgres_container_name},
  {"db.port": 5432},
  {"hmac_key": values.invidious.hmac_secret},
  {"host_binding": "0.0.0.0"},
  {"port": values.network.web_port.port_number},
  {"admins": values.invidious.admins},
  {"registration_enabled": values.invidious.registration_enabled},
  {"login_enabled": values.invidious.login_enabled},
  {"captcha_enabled": values.invidious.captcha_enabled},
  {"invidious_companion_key": values.invidious.companion_key},
  {"invidious_companion[0].private_url": "http://%s:%s/companion"|format(values.consts.companion_container_name, values.consts.inv_companion_port)},
]) %}

{% do config.set_user(values.consts.run_as_user, values.consts.run_as_group) %}
{% do config.setup_as_helper() %}
{% do config.configs.add("config.sh", config_macro.config(values=values, cfg=cfg.x), "/setup/config.sh", "0755") %}
{% do config.set_entrypoint(["/setup/config.sh"]) %}
{% do config.depends.add_dependency(values.consts.db_seed_apply_container_name, "service_completed_successfully") %}

{% set shared_volume_config = {"type": "temporary", "volume_config": {"volume_name": "shared"}} %}
{% do db_fetch.add_storage("/shared", shared_volume_config) %}
{% do db_seed.add_storage("/shared", shared_volume_config) %}
{% do config.add_storage("/shared", shared_volume_config) %}
{% do perm_container.add_or_skip_action("shared", shared_volume_config, perms_config) %}

{% do c1.add_storage(values.consts.config_path, values.storage.config) %}
{% do db_fetch.add_storage(values.consts.config_path, values.storage.config) %}
{% do db_seed.add_storage(values.consts.config_path, values.storage.config) %}
{% do config.add_storage(values.consts.config_path, values.storage.config) %}
{% do perm_container.add_or_skip_action("config", values.storage.config, perms_config) %}

{% for store in values.storage.additional_storage %}
  {% do c1.add_storage(store.mount_path, values.storage.config) %}
  {% do perm_container.add_or_skip_action(store.mount_path, store, perms_config) %}
{% endfor %}

{% if perm_container.has_actions() %}
  {% do perm_container.activate() %}
  {% do c1.depends.add_dependency(values.consts.perms_container_name, "service_completed_successfully") %}
  {% do db_fetch.depends.add_dependency(values.consts.perms_container_name, "service_completed_successfully") %}
  {% do db_seed.depends.add_dependency(values.consts.perms_container_name, "service_completed_successfully") %}
  {% do config.depends.add_dependency(values.consts.perms_container_name, "service_completed_successfully") %}
  {% do companion.depends.add_dependency(values.consts.perms_container_name, "service_completed_successfully") %}
  {% do postgres.add_dependency(values.consts.perms_container_name, "service_completed_successfully") %}
{% endif %}

{% do tpl.portals.add(values.network.web_port) %}

{{ tpl.render() | tojson }}
