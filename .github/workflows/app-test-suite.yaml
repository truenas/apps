name: Apps Test Suite

# TODO: remove once image is public
permissions:
  contents: read
  packages: read

on:
  pull_request: {}

jobs:
  changed-files:
    name: Generate matrix
    runs-on: ubuntu-latest
    outputs:
      changed-apps: ${{ steps.changed-apps.outputs.changed-apps }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get changed files
        id: changed-files-json
        uses: tj-actions/changed-files@v44
        with:
          json: true

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Matrix Output
        id: changed-apps
        env:
          CHANGED_FILES: ${{ steps.changed-files-json.outputs.all_changed_files }}
        run: |
          out=$(python3 .github/scripts/changed_apps.py)
          echo "changed-apps=${out}" >> $GITHUB_OUTPUT

  run-apps:
    name: Run Docker Compose Render/Install
    needs: changed-files
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.changed-files.outputs.changed-apps) }}
      fail-fast: false
      max-parallel: 10
    steps:
      - name: Environment Information
        run: |
          echo "====== Docker Info ======"
          docker info
          echo "========================="

      # TODO: remove once image is public
      - name: Login to GHCR
        uses: docker/login-action@28218f9b04b4f3f62068d7b6ce6ca5b26e35336c
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout
        uses: actions/checkout@v4

      - name: Test
        shell: bash
        run: |
          echo "Testing [${{matrix.train}}/${{matrix.app}}/test_values/${{matrix.test_file}}]"
          ./.github/scripts/ci.sh ${{matrix.train}} ${{matrix.app}} ${{matrix.test_file}}
