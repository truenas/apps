name: Test App Install

on:
  pull_request: {}

jobs:
  changed-files:
    name: Get changed apps
    runs-on: ubuntu-latest
    outputs:
      changed-apps: ${{ steps.changed-apps.outputs.changed-apps }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Get changed files
        id: changed-files-json
        uses: tj-actions/changed-files@v44
        with:
          json: true

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      # - name: Setup Go
      #   uses: actions/setup-go@v4
      #   with:
      #     go-version: "1.22.2"
      - name: Get changed apps
        id: changed-apps
        env:
          CHANGED_FILES: ${{ steps.changed-files-json.outputs.all_changed_files }}
        run: |
          out=$(python3 .github/scripts/changed_apps.py)
          echo "changed-apps=${out}" >> $GITHUB_OUTPUT
          echo "$out"

      # - name: Get changed apps
      #   id: changed-apps
      #   env:
      #     CHANGED_FILES: ${{ steps.changed-files-json.outputs.all_changed_files }}
      #   run: |
      #     echo $CHANGED_FILES
      #     out=$(go run ./tools/get-changed-apps/cmd/main.go)
      #     echo "changed-apps=${out}" >> $GITHUB_OUTPUT
      #     echo $out

  test-apps:
    name: Test apps
    needs: changed-files
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ needs.changed-files.outputs.changed-apps }}
    steps:
      - name: Environment Information
        run: |
          echo "====== Docker Info ======"
          docker info
          echo "========================="
      - name: Checkout
        uses: actions/checkout@v4
      - name: Run app
        shell: bash
        run: |
          echo "Running CI script"
          train_dir=$(echo ${{ matrix.app }} | cut -d'/' -f1)
          app_name=$(echo ${{ matrix.app }} | cut -d'/' -f2)
          ./.github/scripts/ci.sh $train_dir $app_name
