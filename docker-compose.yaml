name: 958c9665b740355bd7d47667f50e3a94
services:
  arcade:
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
    cap_drop:
      - ALL
    configs:
      - source: arcade_entrypoint
        target: /ix-entrypoint.sh
        mode: "0755"
    depends_on:
      permissions:
        condition: service_completed_successfully
        required: true
    deploy:
      resources:
        limits:
          cpus: 1
          memory: "536870912"
    entrypoint:
      - /ix-entrypoint.sh
    environment:
      GID: "568"
      GROUP_ID: "568"
      NVIDIA_VISIBLE_DEVICES: void
      PGID: "568"
      PUID: "568"
      TZ: Etc/UTC
      UID: "568"
      UMASK: "002"
      UMASK_SET: "002"
      USER_ID: "568"
    group_add:
      - "568"
    healthcheck:
      disable: true
    image: opencloudeu/web-extensions:arcade-0.1.0
    networks:
      default: null
    platform: linux/amd64
    restart: on-failure:1
    security_opt:
      - no-new-privileges=true
    user: "0:0"
    volumes:
      - type: bind
        source: /mnt/data/test/opencloud/data
        target: /var/lib/opencloud
        bind:
          propagation: rprivate
          create_host_path: true
  cast:
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
    cap_drop:
      - ALL
    configs:
      - source: cast_entrypoint
        target: /ix-entrypoint.sh
        mode: "0755"
    depends_on:
      permissions:
        condition: service_completed_successfully
        required: true
    deploy:
      resources:
        limits:
          cpus: 1
          memory: "536870912"
    entrypoint:
      - /ix-entrypoint.sh
    environment:
      GID: "568"
      GROUP_ID: "568"
      NVIDIA_VISIBLE_DEVICES: void
      PGID: "568"
      PUID: "568"
      TZ: Etc/UTC
      UID: "568"
      UMASK: "002"
      UMASK_SET: "002"
      USER_ID: "568"
    group_add:
      - "568"
    healthcheck:
      disable: true
    image: opencloudeu/web-extensions:cast-1.0.0
    networks:
      default: null
    platform: linux/amd64
    restart: on-failure:1
    security_opt:
      - no-new-privileges=true
    user: "0:0"
    volumes:
      - type: bind
        source: /mnt/data/test/opencloud/data
        target: /var/lib/opencloud
        bind:
          propagation: rprivate
          create_host_path: true
  draw-io:
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
    cap_drop:
      - ALL
    configs:
      - source: draw-io_entrypoint
        target: /ix-entrypoint.sh
        mode: "0755"
    depends_on:
      permissions:
        condition: service_completed_successfully
        required: true
    deploy:
      resources:
        limits:
          cpus: 1
          memory: "536870912"
    entrypoint:
      - /ix-entrypoint.sh
    environment:
      GID: "568"
      GROUP_ID: "568"
      NVIDIA_VISIBLE_DEVICES: void
      PGID: "568"
      PUID: "568"
      TZ: Etc/UTC
      UID: "568"
      UMASK: "002"
      UMASK_SET: "002"
      USER_ID: "568"
    group_add:
      - "568"
    healthcheck:
      disable: true
    image: opencloudeu/web-extensions:draw-io-1.0.0
    networks:
      default: null
    platform: linux/amd64
    restart: on-failure:1
    security_opt:
      - no-new-privileges=true
    user: "0:0"
    volumes:
      - type: bind
        source: /mnt/data/test/opencloud/data
        target: /var/lib/opencloud
        bind:
          propagation: rprivate
          create_host_path: true
  external-sites:
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
    cap_drop:
      - ALL
    configs:
      - source: external-sites_entrypoint
        target: /ix-entrypoint.sh
        mode: "0755"
    depends_on:
      permissions:
        condition: service_completed_successfully
        required: true
    deploy:
      resources:
        limits:
          cpus: 1
          memory: "536870912"
    entrypoint:
      - /ix-entrypoint.sh
    environment:
      GID: "568"
      GROUP_ID: "568"
      NVIDIA_VISIBLE_DEVICES: void
      PGID: "568"
      PUID: "568"
      TZ: Etc/UTC
      UID: "568"
      UMASK: "002"
      UMASK_SET: "002"
      USER_ID: "568"
    group_add:
      - "568"
    healthcheck:
      disable: true
    image: opencloudeu/web-extensions:external-sites-1.0.0
    networks:
      default: null
    platform: linux/amd64
    restart: on-failure:1
    security_opt:
      - no-new-privileges=true
    user: "0:0"
    volumes:
      - type: bind
        source: /mnt/data/test/opencloud/data
        target: /var/lib/opencloud
        bind:
          propagation: rprivate
          create_host_path: true
  importer:
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
    cap_drop:
      - ALL
    configs:
      - source: importer_entrypoint
        target: /ix-entrypoint.sh
        mode: "0755"
    depends_on:
      permissions:
        condition: service_completed_successfully
        required: true
    deploy:
      resources:
        limits:
          cpus: 1
          memory: "536870912"
    entrypoint:
      - /ix-entrypoint.sh
    environment:
      GID: "568"
      GROUP_ID: "568"
      NVIDIA_VISIBLE_DEVICES: void
      PGID: "568"
      PUID: "568"
      TZ: Etc/UTC
      UID: "568"
      UMASK: "002"
      UMASK_SET: "002"
      USER_ID: "568"
    group_add:
      - "568"
    healthcheck:
      disable: true
    image: opencloudeu/web-extensions:importer-1.0.0
    networks:
      default: null
    platform: linux/amd64
    restart: on-failure:1
    security_opt:
      - no-new-privileges=true
    user: "0:0"
    volumes:
      - type: bind
        source: /mnt/data/test/opencloud/data
        target: /var/lib/opencloud
        bind:
          propagation: rprivate
          create_host_path: true
  json-viewer:
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
    cap_drop:
      - ALL
    configs:
      - source: json-viewer_entrypoint
        target: /ix-entrypoint.sh
        mode: "0755"
    depends_on:
      permissions:
        condition: service_completed_successfully
        required: true
    deploy:
      resources:
        limits:
          cpus: 1
          memory: "536870912"
    entrypoint:
      - /ix-entrypoint.sh
    environment:
      GID: "568"
      GROUP_ID: "568"
      NVIDIA_VISIBLE_DEVICES: void
      PGID: "568"
      PUID: "568"
      TZ: Etc/UTC
      UID: "568"
      UMASK: "002"
      UMASK_SET: "002"
      USER_ID: "568"
    group_add:
      - "568"
    healthcheck:
      disable: true
    image: opencloudeu/web-extensions:json-viewer-1.0.0
    networks:
      default: null
    platform: linux/amd64
    restart: on-failure:1
    security_opt:
      - no-new-privileges=true
    user: "0:0"
    volumes:
      - type: bind
        source: /mnt/data/test/opencloud/data
        target: /var/lib/opencloud
        bind:
          propagation: rprivate
          create_host_path: true
  maps:
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
    cap_drop:
      - ALL
    configs:
      - source: maps_entrypoint
        target: /ix-entrypoint.sh
        mode: "0755"
    depends_on:
      permissions:
        condition: service_completed_successfully
        required: true
    deploy:
      resources:
        limits:
          cpus: 1
          memory: "536870912"
    entrypoint:
      - /ix-entrypoint.sh
    environment:
      GID: "568"
      GROUP_ID: "568"
      NVIDIA_VISIBLE_DEVICES: void
      PGID: "568"
      PUID: "568"
      TZ: Etc/UTC
      UID: "568"
      UMASK: "002"
      UMASK_SET: "002"
      USER_ID: "568"
    group_add:
      - "568"
    healthcheck:
      disable: true
    image: opencloudeu/web-extensions:maps-0.1.0
    networks:
      default: null
    platform: linux/amd64
    restart: on-failure:1
    security_opt:
      - no-new-privileges=true
    user: "0:0"
    volumes:
      - type: bind
        source: /mnt/data/test/opencloud/data
        target: /var/lib/opencloud
        bind:
          propagation: rprivate
          create_host_path: true
  opencloud:
    cap_drop:
      - ALL
    configs:
      - source: entrypoint
        target: /ix-entrypoint.sh
        mode: "0755"
    depends_on:
      arcade:
        condition: service_completed_successfully
        required: true
      cast:
        condition: service_completed_successfully
        required: true
      draw-io:
        condition: service_completed_successfully
        required: true
      external-sites:
        condition: service_completed_successfully
        required: true
      importer:
        condition: service_completed_successfully
        required: true
      json-viewer:
        condition: service_completed_successfully
        required: true
      maps:
        condition: service_completed_successfully
        required: true
      permissions:
        condition: service_completed_successfully
        required: true
      progress-bars:
        condition: service_completed_successfully
        required: true
      unzip:
        condition: service_completed_successfully
        required: true
    deploy:
      resources:
        limits:
          cpus: 2
          memory: "4294967296"
    entrypoint:
      - /ix-entrypoint.sh
    environment:
      GID: "568"
      GROUP_ID: "568"
      NOTIFICATIONS_SMTP_SENDER: OpenCloud notifications <notifications@cloud.opencloud.test>
      NVIDIA_VISIBLE_DEVICES: void
      OC_ADD_RUN_SERVICES: notifications
      OC_BASE_DATA_PATH: /var/lib/opencloud
      OC_CONFIG_DIR: /etc/opencloud
      OC_INSECURE: "true"
      OC_URL: https://10.20.30.6:8080
      PGID: "568"
      PROXY_HTTP_ADDR: :8080
      PUID: "568"
      STORAGE_USERS_DRIVER: posix
      STORAGE_USERS_ID_CACHE_STORE: nats-js-kv
      TZ: Etc/UTC
      UID: "568"
      UMASK: "002"
      UMASK_SET: "002"
      USER_ID: "568"
    group_add:
      - "568"
    healthcheck:
      test:
        - CMD
        - curl
        - --request
        - GET
        - --silent
        - --output
        - /dev/null
        - --show-error
        - --fail
        - --insecure
        - https://127.0.0.1:8080/healthz
      timeout: 5s
      interval: 30s
      retries: 5
      start_period: 15s
      start_interval: 2s
    image: opencloudeu/opencloud-rolling:3.4.0
    networks:
      default: null
    platform: linux/amd64
    ports:
      - mode: ingress
        target: 8080
        published: "8080"
        protocol: tcp
    restart: unless-stopped
    security_opt:
      - no-new-privileges=true
    user: 568:568
    volumes:
      - type: bind
        source: /mnt/data/test/opencloud/config
        target: /etc/opencloud
        bind:
          propagation: rprivate
          create_host_path: true
      - type: bind
        source: /mnt/data/test/opencloud/data
        target: /var/lib/opencloud
        bind:
          propagation: rprivate
          create_host_path: true
  permissions:
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
    cap_drop:
      - ALL
    configs:
      - source: permissions_actions_data
        target: /script/actions.json
        mode: "0500"
      - source: permissions_run_script
        target: /script/run.py
        mode: "0700"
    deploy:
      resources:
        limits:
          cpus: 2
          memory: "1073741824"
    entrypoint:
      - python3
      - /script/run.py
    environment:
      GID: "568"
      GROUP_ID: "568"
      NVIDIA_VISIBLE_DEVICES: void
      PGID: "568"
      PUID: "568"
      TZ: Etc/UTC
      UID: "568"
      UMASK: "002"
      UMASK_SET: "002"
      USER_ID: "568"
    group_add:
      - "568"
    healthcheck:
      disable: true
    image: python:3.13.0-slim-bookworm
    network_mode: none
    platform: linux/amd64
    restart: on-failure:1
    security_opt:
      - no-new-privileges=true
    user: "0:0"
    volumes:
      - type: bind
        source: /mnt/data/test/opencloud/config
        target: /mnt/permission/config
        bind:
          propagation: rprivate
          create_host_path: true
      - type: bind
        source: /mnt/data/test/opencloud/data
        target: /mnt/permission/data
        bind:
          propagation: rprivate
          create_host_path: true
  progress-bars:
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
    cap_drop:
      - ALL
    configs:
      - source: progress-bars_entrypoint
        target: /ix-entrypoint.sh
        mode: "0755"
    depends_on:
      permissions:
        condition: service_completed_successfully
        required: true
    deploy:
      resources:
        limits:
          cpus: 1
          memory: "536870912"
    entrypoint:
      - /ix-entrypoint.sh
    environment:
      GID: "568"
      GROUP_ID: "568"
      NVIDIA_VISIBLE_DEVICES: void
      PGID: "568"
      PUID: "568"
      TZ: Etc/UTC
      UID: "568"
      UMASK: "002"
      UMASK_SET: "002"
      USER_ID: "568"
    group_add:
      - "568"
    healthcheck:
      disable: true
    image: opencloudeu/web-extensions:progress-bars-1.0.0
    networks:
      default: null
    platform: linux/amd64
    restart: on-failure:1
    security_opt:
      - no-new-privileges=true
    user: "0:0"
    volumes:
      - type: bind
        source: /mnt/data/test/opencloud/data
        target: /var/lib/opencloud
        bind:
          propagation: rprivate
          create_host_path: true
  unzip:
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
    cap_drop:
      - ALL
    configs:
      - source: unzip_entrypoint
        target: /ix-entrypoint.sh
        mode: "0755"
    depends_on:
      permissions:
        condition: service_completed_successfully
        required: true
    deploy:
      resources:
        limits:
          cpus: 1
          memory: "536870912"
    entrypoint:
      - /ix-entrypoint.sh
    environment:
      GID: "568"
      GROUP_ID: "568"
      NVIDIA_VISIBLE_DEVICES: void
      PGID: "568"
      PUID: "568"
      TZ: Etc/UTC
      UID: "568"
      UMASK: "002"
      UMASK_SET: "002"
      USER_ID: "568"
    group_add:
      - "568"
    healthcheck:
      disable: true
    image: opencloudeu/web-extensions:unzip-1.0.2
    networks:
      default: null
    platform: linux/amd64
    restart: on-failure:1
    security_opt:
      - no-new-privileges=true
    user: "0:0"
    volumes:
      - type: bind
        source: /mnt/data/test/opencloud/data
        target: /var/lib/opencloud
        bind:
          propagation: rprivate
          create_host_path: true
networks:
  default:
    name: 958c9665b740355bd7d47667f50e3a94_default
configs:
  arcade_entrypoint:
    name: 958c9665b740355bd7d47667f50e3a94_arcade_entrypoint
    content: |
      #!/bin/sh
      set -e
      if [ -d /var/lib/opencloud/web/assets/apps/arcade ]; then
        echo "Removing old app files for [arcade] from /var/lib/opencloud/web/assets/apps/arcade]"
        rm -rf /var/lib/opencloud/web/assets/apps/arcade
      fi



      mkdir -p /var/lib/opencloud/web/assets/apps/arcade

      echo "Copying app files for [arcade] to [/var/lib/opencloud/web/assets/apps/arcade] from [/usr/share/nginx/html/apps/arcade]"
      cp -R /usr/share/nginx/html/apps/arcade /var/lib/opencloud/web/assets/apps

      echo "Setting ownership to [568:568] for [/var/lib/opencloud/web/assets/apps/arcade]"
      chown -R 568:568 /var/lib/opencloud/web/assets/apps/arcade

      echo "Done!"
  cast_entrypoint:
    name: 958c9665b740355bd7d47667f50e3a94_cast_entrypoint
    content: |
      #!/bin/sh
      set -e
      if [ -d /var/lib/opencloud/web/assets/apps/cast ]; then
        echo "Removing old app files for [cast] from /var/lib/opencloud/web/assets/apps/cast]"
        rm -rf /var/lib/opencloud/web/assets/apps/cast
      fi



      mkdir -p /var/lib/opencloud/web/assets/apps/cast

      echo "Copying app files for [cast] to [/var/lib/opencloud/web/assets/apps/cast] from [/usr/share/nginx/html/cast]"
      cp -R /usr/share/nginx/html/cast /var/lib/opencloud/web/assets/apps

      echo "Setting ownership to [568:568] for [/var/lib/opencloud/web/assets/apps/cast]"
      chown -R 568:568 /var/lib/opencloud/web/assets/apps/cast

      echo "Done!"
  draw-io_entrypoint:
    name: 958c9665b740355bd7d47667f50e3a94_draw-io_entrypoint
    content: |
      #!/bin/sh
      set -e
      if [ -d /var/lib/opencloud/web/assets/apps/draw-io ]; then
        echo "Removing old app files for [draw-io] from /var/lib/opencloud/web/assets/apps/draw-io]"
        rm -rf /var/lib/opencloud/web/assets/apps/draw-io
      fi



      mkdir -p /var/lib/opencloud/web/assets/apps/draw-io

      echo "Copying app files for [draw-io] to [/var/lib/opencloud/web/assets/apps/draw-io] from [/usr/share/nginx/html/draw-io]"
      cp -R /usr/share/nginx/html/draw-io /var/lib/opencloud/web/assets/apps

      echo "Setting ownership to [568:568] for [/var/lib/opencloud/web/assets/apps/draw-io]"
      chown -R 568:568 /var/lib/opencloud/web/assets/apps/draw-io

      echo "Done!"
  entrypoint:
    name: 958c9665b740355bd7d47667f50e3a94_entrypoint
    content: |
      #!/bin/sh
      set -e
      if [ ! -f $$OC_CONFIG_DIR/opencloud.yaml ]; then
        echo "Config file not found!"
        opencloud init
      fi
      echo "Starting OpenCloud..."
      opencloud server
  external-sites_entrypoint:
    name: 958c9665b740355bd7d47667f50e3a94_external-sites_entrypoint
    content: |
      #!/bin/sh
      set -e
      if [ -d /var/lib/opencloud/web/assets/apps/external-sites ]; then
        echo "Removing old app files for [external-sites] from /var/lib/opencloud/web/assets/apps/external-sites]"
        rm -rf /var/lib/opencloud/web/assets/apps/external-sites
      fi



      mkdir -p /var/lib/opencloud/web/assets/apps/external-sites

      echo "Copying app files for [external-sites] to [/var/lib/opencloud/web/assets/apps/external-sites] from [/usr/share/nginx/html/external-sites]"
      cp -R /usr/share/nginx/html/external-sites /var/lib/opencloud/web/assets/apps

      echo "Setting ownership to [568:568] for [/var/lib/opencloud/web/assets/apps/external-sites]"
      chown -R 568:568 /var/lib/opencloud/web/assets/apps/external-sites

      echo "Done!"
  importer_entrypoint:
    name: 958c9665b740355bd7d47667f50e3a94_importer_entrypoint
    content: |
      #!/bin/sh
      set -e
      if [ -d /var/lib/opencloud/web/assets/apps/importer ]; then
        echo "Removing old app files for [importer] from /var/lib/opencloud/web/assets/apps/importer]"
        rm -rf /var/lib/opencloud/web/assets/apps/importer
      fi



      mkdir -p /var/lib/opencloud/web/assets/apps/importer

      echo "Copying app files for [importer] to [/var/lib/opencloud/web/assets/apps/importer] from [/usr/share/nginx/html/importer]"
      cp -R /usr/share/nginx/html/importer /var/lib/opencloud/web/assets/apps

      echo "Setting ownership to [568:568] for [/var/lib/opencloud/web/assets/apps/importer]"
      chown -R 568:568 /var/lib/opencloud/web/assets/apps/importer

      echo "Done!"
  json-viewer_entrypoint:
    name: 958c9665b740355bd7d47667f50e3a94_json-viewer_entrypoint
    content: |
      #!/bin/sh
      set -e
      if [ -d /var/lib/opencloud/web/assets/apps/json-viewer ]; then
        echo "Removing old app files for [json-viewer] from /var/lib/opencloud/web/assets/apps/json-viewer]"
        rm -rf /var/lib/opencloud/web/assets/apps/json-viewer
      fi



      mkdir -p /var/lib/opencloud/web/assets/apps/json-viewer

      echo "Copying app files for [json-viewer] to [/var/lib/opencloud/web/assets/apps/json-viewer] from [/usr/share/nginx/html/json-viewer]"
      cp -R /usr/share/nginx/html/json-viewer /var/lib/opencloud/web/assets/apps

      echo "Setting ownership to [568:568] for [/var/lib/opencloud/web/assets/apps/json-viewer]"
      chown -R 568:568 /var/lib/opencloud/web/assets/apps/json-viewer

      echo "Done!"
  maps_entrypoint:
    name: 958c9665b740355bd7d47667f50e3a94_maps_entrypoint
    content: |
      #!/bin/sh
      set -e
      if [ -d /var/lib/opencloud/web/assets/apps/maps ]; then
        echo "Removing old app files for [maps] from /var/lib/opencloud/web/assets/apps/maps]"
        rm -rf /var/lib/opencloud/web/assets/apps/maps
      fi



      mkdir -p /var/lib/opencloud/web/assets/apps/maps

      echo "Copying app files for [maps] to [/var/lib/opencloud/web/assets/apps/maps] from [/usr/share/nginx/html/apps/maps]"
      cp -R /usr/share/nginx/html/apps/maps /var/lib/opencloud/web/assets/apps

      echo "Setting ownership to [568:568] for [/var/lib/opencloud/web/assets/apps/maps]"
      chown -R 568:568 /var/lib/opencloud/web/assets/apps/maps

      echo "Done!"
  permissions_actions_data:
    name: 958c9665b740355bd7d47667f50e3a94_permissions_actions_data
    content: '[{"read_only": false, "mount_path": "/mnt/permission/config", "is_temporary": false, "identifier": "config", "recursive": false, "mode": "check", "uid": 568, "gid": 568, "chmod": null}, {"read_only": false, "mount_path": "/mnt/permission/data", "is_temporary": false, "identifier": "data", "recursive": false, "mode": "check", "uid": 568, "gid": 568, "chmod": null}]'
  permissions_run_script:
    name: 958c9665b740355bd7d47667f50e3a94_permissions_run_script
    content: |
      #!/usr/bin/env python3

      import os
      import json
      import time
      import shutil

      with open("/script/actions.json", "r") as f:
          actions_data = json.load(f)

      if not actions_data:
          # If this script is called, there should be actions data
          raise ValueError("No actions data found")

      def fix_perms(path, chmod, recursive=False):
          print(f"Changing permissions{' recursively ' if recursive else ' '}to {chmod} on: [{path}]")
          os.chmod(path, int(chmod, 8))
          if recursive:
              for root, dirs, files in os.walk(path):
                  for f in files:
                      os.chmod(os.path.join(root, f), int(chmod, 8))
          print("Permissions after changes:")
          print_chmod_stat()

      def fix_owner(path, uid, gid, recursive=False):
          print(f"Changing ownership{' recursively ' if recursive else ' '}to {uid}:{gid} on: [{path}]")
          os.chown(path, uid, gid)
          if recursive:
              for root, dirs, files in os.walk(path):
                  for f in files:
                      os.chown(os.path.join(root, f), uid, gid)
          print("Ownership after changes:")
          print_chown_stat()

      def print_chown_stat():
          curr_stat = os.stat(action["mount_path"])
          print(f"Ownership: [{curr_stat.st_uid}:{curr_stat.st_gid}]")

      def print_chmod_stat():
          curr_stat = os.stat(action["mount_path"])
          print(f"Permissions: [{oct(curr_stat.st_mode)[3:]}]")

      def print_chown_diff(curr_stat, uid, gid):
          print(f"Ownership: wanted [{uid}:{gid}], got [{curr_stat.st_uid}:{curr_stat.st_gid}].")

      def print_chmod_diff(curr_stat, mode):
          print(f"Permissions: wanted [{mode}], got [{oct(curr_stat.st_mode)[3:]}].")

      def perform_action(action):
          if action["read_only"]:
              print(f"Path for action [{action['identifier']}] is read-only, skipping...")
              return

          start_time = time.time()
          print(f"=== Applying configuration on volume with identifier [{action['identifier']}] ===")

          if not os.path.isdir(action["mount_path"]):
              print(f"Path [{action['mount_path']}] is not a directory, skipping...")
              return

          if action["is_temporary"]:
              print(f"Path [{action['mount_path']}] is a temporary directory, ensuring it is empty...")
              for item in os.listdir(action["mount_path"]):
                  item_path = os.path.join(action["mount_path"], item)

                  # Exclude the safe directory, where we can use to mount files temporarily
                  if os.path.basename(item_path) == "ix-safe":
                      continue
                  if os.path.isdir(item_path):
                      shutil.rmtree(item_path)
                  else:
                      os.remove(item_path)

          if not action["is_temporary"] and os.listdir(action["mount_path"]):
              print(f"Path [{action['mount_path']}] is not empty, skipping...")
              return

          print(f"Current Ownership and Permissions on [{action['mount_path']}]:")
          curr_stat = os.stat(action["mount_path"])
          print_chown_diff(curr_stat, action["uid"], action["gid"])
          print_chmod_diff(curr_stat, action["chmod"])
          print("---")

          if action["mode"] == "always":
              fix_owner(action["mount_path"], action["uid"], action["gid"], action["recursive"])
              if not action["chmod"]:
                  print("Skipping permissions check, chmod is falsy")
              else:
                  fix_perms(action["mount_path"], action["chmod"], action["recursive"])
              return

          elif action["mode"] == "check":
              if curr_stat.st_uid != action["uid"] or curr_stat.st_gid != action["gid"]:
                  print("Ownership is incorrect. Fixing...")
                  fix_owner(action["mount_path"], action["uid"], action["gid"], action["recursive"])
              else:
                  print("Ownership is correct. Skipping...")

              if not action["chmod"]:
                  print("Skipping permissions check, chmod is falsy")
              else:
                  if oct(curr_stat.st_mode)[3:] != action["chmod"]:
                      print("Permissions are incorrect. Fixing...")
                      fix_perms(action["mount_path"], action["chmod"], action["recursive"])
                  else:
                      print("Permissions are correct. Skipping...")

          print(f"Time taken: {(time.time() - start_time) * 1000:.2f}ms")
          print(f"=== Finished applying configuration on volume with identifier [{action['identifier']}] ==")
          print()

      if __name__ == "__main__":
          start_time = time.time()
          for action in actions_data:
              perform_action(action)
          print(f"Total time taken: {(time.time() - start_time) * 1000:.2f}ms")
  progress-bars_entrypoint:
    name: 958c9665b740355bd7d47667f50e3a94_progress-bars_entrypoint
    content: |
      #!/bin/sh
      set -e
      if [ -d /var/lib/opencloud/web/assets/apps/progress-bars ]; then
        echo "Removing old app files for [progress-bars] from /var/lib/opencloud/web/assets/apps/progress-bars]"
        rm -rf /var/lib/opencloud/web/assets/apps/progress-bars
      fi



      mkdir -p /var/lib/opencloud/web/assets/apps/progress-bars

      echo "Copying app files for [progress-bars] to [/var/lib/opencloud/web/assets/apps/progress-bars] from [/usr/share/nginx/html/progress-bars]"
      cp -R /usr/share/nginx/html/progress-bars /var/lib/opencloud/web/assets/apps

      echo "Setting ownership to [568:568] for [/var/lib/opencloud/web/assets/apps/progress-bars]"
      chown -R 568:568 /var/lib/opencloud/web/assets/apps/progress-bars

      echo "Done!"
  unzip_entrypoint:
    name: 958c9665b740355bd7d47667f50e3a94_unzip_entrypoint
    content: |
      #!/bin/sh
      set -e
      if [ -d /var/lib/opencloud/web/assets/apps/unzip ]; then
        echo "Removing old app files for [unzip] from /var/lib/opencloud/web/assets/apps/unzip]"
        rm -rf /var/lib/opencloud/web/assets/apps/unzip
      fi



      mkdir -p /var/lib/opencloud/web/assets/apps/unzip

      echo "Copying app files for [unzip] to [/var/lib/opencloud/web/assets/apps/unzip] from [/usr/share/nginx/html/unzip]"
      cp -R /usr/share/nginx/html/unzip /var/lib/opencloud/web/assets/apps

      echo "Setting ownership to [568:568] for [/var/lib/opencloud/web/assets/apps/unzip]"
      chown -R 568:568 /var/lib/opencloud/web/assets/apps/unzip

      echo "Done!"
x-notes: |+
  # <app_name>

  ## Info

  - The app 'external_sites' requires additional configuration. Please see https://github.com/opencloud-eu/web-extensions/tree/main/packages/web-app-external-sites for details.

  ## Security

  ### Container: [draw-io]

  **This container is short-lived.**

  - Is running as root user
  - Is running as root group

  ### Container: [progress-bars]

  **This container is short-lived.**

  - Is running as root user
  - Is running as root group

  ### Container: [json-viewer]

  **This container is short-lived.**

  - Is running as root user
  - Is running as root group

  ### Container: [external-sites]

  **This container is short-lived.**

  - Is running as root user
  - Is running as root group

  ### Container: [unzip]

  **This container is short-lived.**

  - Is running as root user
  - Is running as root group

  ### Container: [cast]

  **This container is short-lived.**

  - Is running as root user
  - Is running as root group

  ### Container: [arcade]

  **This container is short-lived.**

  - Is running as root user
  - Is running as root group

  ### Container: [maps]

  **This container is short-lived.**

  - Is running as root user
  - Is running as root group

  ### Container: [importer]

  **This container is short-lived.**

  - Is running as root user
  - Is running as root group

  ### Container: [permissions]

  **This container is short-lived.**

  - Is running as root user
  - Is running as root group

  If you installed an app that needs additional configuration, please see</br>
  the following link on how to convert the config.json config into /etc/opencloud/apps.yaml
  https://docs.opencloud.eu/docs/dev/server/Services/web/Web-info/#application-configuration

  ## Bug Reports and Feature Requests

  If you find a bug in this app or have an idea for a new feature, please file an issue at
  https://github.com/truenas/apps

x-portals:
  - host: 0.0.0.0
    name: Web UI
    path: /
    port: 8080
    scheme: https

