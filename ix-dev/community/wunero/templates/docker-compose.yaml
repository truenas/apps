{# Initialize rendering system #}
{% set tpl = ix_lib.base.render.Render(values) %}

{# Add main Wunero container #}
{% set app = tpl.add_container(values.consts.app_container_name, "image") %}
{% do app.set_user(values.run_as.user, values.run_as.group) %}

{# Configure healthcheck #}
{% do app.healthcheck.set_test("curl", {"port": values.network.web_port.port_number, "path": "/"}) %}

{# Environment variables #}
{% do app.environment.add_env("NODE_ENV", "production") %}
{% do app.environment.add_env("PORT", 3000) %}
{% do app.environment.add_env("HOSTNAME", "0.0.0.0") %}
{% do app.environment.add_env("DB_PATH", "/app/data") %}
{% do app.environment.add_env("NEXTAUTH_URL", values.wunero.nextauth_url) %}

{# NextAuth Secret - auto-generate if not provided #}
{% if values.wunero.nextauth_secret %}
  {% do app.environment.add_env("NEXTAUTH_SECRET", values.wunero.nextauth_secret) %}
{% else %}
  {% do app.environment.add_env("NEXTAUTH_SECRET", tpl.utils.generate_random_string(values.consts.nextauth_secret_length)) %}
{% endif %}

{# Optional Resend API key #}
{% if values.wunero.resend_api_key %}
  {% do app.environment.add_env("RESEND_API_KEY", values.wunero.resend_api_key) %}
{% endif %}

{# Additional environment variables #}
{% for env in values.wunero.additional_envs %}
  {% do app.environment.add_env(env.name, env.value) %}
{% endfor %}

{# Network configuration #}
{% do app.add_port(values.network.web_port) %}

{# Storage configuration #}
{% do app.add_storage("/app/data", values.storage.data) %}

{# Additional storage mounts #}
{% for storage_entry in values.storage.additional_storage %}
  {% do app.add_storage(storage_entry.mount_path, storage_entry) %}
{% endfor %}

{# Setup permissions container #}
{% set perms = tpl.deps.perms(values.consts.perms_container_name) %}
{% set perms_config = {"uid": values.run_as.user, "gid": values.run_as.group, "mode": "check"} %}
{% do perms.add_or_skip_action("data", values.storage.data, perms_config) %}

{# Additional storage permissions #}
{% for storage_entry in values.storage.additional_storage %}
  {% do perms.add_or_skip_action("additional_" ~ loop.index, storage_entry, perms_config) %}
{% endfor %}

{# Activate permissions container if needed #}
{% if perms.has_actions() %}
  {% do perms.activate() %}
  {% do app.depends.add_dependency(values.consts.perms_container_name, "service_completed_successfully") %}
{% endif %}

{# Add portal for web UI #}
{% do tpl.portals.add(values.network.web_port) %}

{# Add informational notes #}
{% do tpl.notes.add_info("Wunero is now accessible on the configured port") %}
{% if not values.wunero.nextauth_secret %}
  {% do tpl.notes.add_info("NextAuth secret was auto-generated") %}
{% endif %}
{% if not values.wunero.resend_api_key %}
  {% do tpl.notes.add_warning("Email notifications are disabled. Configure Resend API key to enable.") %}
{% endif %}

{# Render final configuration #}
{{ tpl.render() | tojson }}
