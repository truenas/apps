{% macro setup_js(values) %}
const cfgPath = "{{ values.consts.config_path }}";
const fs = require('fs');

console.log("Starting MeshCentral setup script...");
console.log("Configuration file path: " + cfgPath);

const defaults = [
  [["domains", "", "title"], "TrueNAS MeshCentral"],
  [["domains", "", "newAccounts"], true],
  [["domains", "", "minify"], true],
  [["domains", "", "localSessionRecording"], true]
];

const fileExists = fs.existsSync(cfgPath);
fileExists ? console.log(`File [${cfgPath}] exists, loading...`) : console.log(`File [${cfgPath}] does not exist, creating with defaults...`);

const data = fileExists ? JSON.parse(fs.readFileSync(cfgPath, 'utf8')) : {};

const settings = [
  ...(fileExists ? [] : defaults),
  [["$schema"], "https://raw.githubusercontent.com/Ylianst/MeshCentral/master/meshcentral-config-schema.json"],
  // Those does not make sense in a container
  [["settings", "selfUpdate"], false],
  [["settings", "cleanNpmCacheOnUpdate"], false],

  [["settings", "postgres", "user"], "{{ values.consts.db_user }}"],
  [["settings", "postgres", "database"], "{{ values.consts.db_name }}"],
  [["settings", "postgres", "host"], "{{ values.consts.postgres_container_name }}"],
  [["settings", "postgres", "port"], 5432],
  [["settings", "postgres", "password"], "{{ values.meshcentral.db_password }}"],

  [["settings", "port"], {{ values.network.web_port.port_number }}],
  [["settings", "sessionKey"], "{{ values.meshcentral.session_key }}"]
];

if (data["domains"]) {
  for (const domain of Object.keys(data["domains"])) {
    // Disallow admins to update the server from the "My Server" tab
    settings.push([["domains", domain, "myServer", "Upgrade"], false]);
  }
}

function applyValue(keys, value) {
  let obj = data;
  for (let i = 0; i < keys.length - 1; i++) {
    const key = keys[i];
    if (!obj[key]) obj[key] = {};
    obj = obj[key];
  }
  console.log(`Setting [${keys.join(".")}] to [${value}]`);
  obj[keys[keys.length - 1]] = value;
}

// Changed from Object.entries to direct iteration
for (const [keys, value] of settings) {
  applyValue(keys, value);
}

fs.writeFileSync(cfgPath, JSON.stringify(data, null, 2));
console.log("Done!\n\n");
{% endmacro %}

{% macro setup_sh(values) %}
#!/bin/bash

node /ix-setup.js || { echo "Setup script failed!"; exit 1; }
bash /opt/meshcentral/entrypoint.sh || { echo "Entrypoint script failed!"; exit 1; }
{% endmacro %}
