{% set tpl = ix_lib.base.render.Render(values) %}

{% set container = tpl.add_container(values.consts.container_name, "image") %}
{% do container.set_user(values.run_as.user, values.run_as.group) %}
{% do container.clear_caps() %}

{# Mounts for node-exporter to see the host #}
{% do container.add_storage("/host/proc", {"type": "host_path", "read_only": true, "host_path_config": {"path": "/proc"}}) %}
{% do container.add_storage("/host/sys", {"type": "host_path", "read_only": true, "host_path_config": {"path": "/sys"}}) %}

{% if values.network.host_network %}
  {% do container.set_network_mode("host") %}
{% else %}
  {% do container.add_port(values.network.web_port) %}
{% endif %}

{% set args = ["--path.procfs=/host/proc", "--path.sysfs=/host/sys"] %}
{% if values.node_exporter.collector_mount_points_exclude %}
  {% do args.append("--collector.filesystem.mount-points-exclude=" + values.node_exporter.collector_mount_points_exclude) %}
{% endif %}
{% if values.node_exporter.additional_args %}
  {% do args.extend(values.node_exporter.additional_args) %}
{% endif %}
{% do container.set_command(args) %}

{% do container.healthcheck.set_test("wget", {"port": values.network.web_port.port_number, "path": "/"}) %}

{% for store in values.storage.additional_storage %}
  {% do container.add_storage(store.mount_path, store) %}
{% endfor %}

{% if not values.network.host_network %}
  {% do tpl.portals.add(values.network.web_port) %}
{% endif %}

{{ tpl.render() | tojson }}
