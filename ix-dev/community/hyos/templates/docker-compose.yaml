{# Hytale Server TrueNAS App Template #}
{% set tpl = ix_lib.base.render.Render(values) %}

{# Define capabilities needed for privilege dropping #}
{% set caps = ["CHOWN", "DAC_OVERRIDE", "FOWNER", "SETGID", "SETUID"] %}

{# ============================================================================ #}
{# Hytale Server Container #}
{# ============================================================================ #}
{% set server = tpl.add_container(values.consts.server_container_name, "image") %}

{% do server.set_user(values.run_as.user, values.run_as.group) %}
{% do server.add_caps(caps) %}

{# Disable healthcheck - server blocks on OAuth device flow, can't pass in CI #}
{% do server.healthcheck.disable() %}

{# Enable TTY for OAuth device flow #}
{% do server.set_tty(true) %}
{% do server.set_stdin(true) %}

{# Note: PUID/PGID/TZ are auto-set by set_user() and the library #}

{# ── JVM Configuration ── #}
{% do server.environment.add_env("JAVA_XMS", values.jvm.xms) %}
{% do server.environment.add_env("JAVA_XMX", values.jvm.xmx) %}
{% do server.environment.add_env("USE_ZGC", values.jvm.use_zgc) %}
{% if not values.jvm.use_zgc and values.jvm.g1_max_pause %}
{% do server.environment.add_env("G1_MAX_PAUSE", values.jvm.g1_max_pause) %}
{% endif %}

{# ── Server Configuration ── #}
{% do server.environment.add_env("SERVER_NAME", values.hytale.server_name) %}
{% if values.hytale.server_motd %}
{% do server.environment.add_env("SERVER_MOTD", values.hytale.server_motd) %}
{% endif %}
{% if values.hytale.server_password %}
{% do server.environment.add_env("SERVER_PASSWORD", values.hytale.server_password) %}
{% endif %}
{% do server.environment.add_env("MAX_PLAYERS", values.hytale.max_players) %}
{% do server.environment.add_env("DEFAULT_GAMEMODE", values.hytale.default_gamemode) %}
{% do server.environment.add_env("PATCHLINE", values.hytale.patchline) %}

{# ── Auto-Update Configuration ── #}
{% do server.environment.add_env("AUTO_UPDATE", values.auto_update.enabled) %}
{% if values.auto_update.enabled %}
{% do server.environment.add_env("AUTO_UPDATE_INTERVAL", values.auto_update.interval) %}
{% if values.auto_update.time %}
{% do server.environment.add_env("AUTO_UPDATE_TIME", values.auto_update.time) %}
{% endif %}
{% do server.environment.add_env("AUTO_UPDATE_RESTART", values.auto_update.restart) %}
{% do server.environment.add_env("AUTO_UPDATE_BACKUP", values.auto_update.backup) %}
{% endif %}

{# ── API Configuration ── #}
{% do server.environment.add_env("API_ENABLED", values.api.enabled) %}
{% if values.api.enabled %}
{% do server.environment.add_env("API_CLIENT_SECRET", values.api.client_secret) %}
{% do server.environment.add_env("API_CLIENT_ID", values.api.client_id) %}
{% do server.environment.add_env("API_WEBSOCKET_ENABLED", values.api.websocket_enabled) %}
{% do server.environment.add_env("API_REGENERATE_CONFIG", true) %}
{% endif %}

{# ── Advanced Configuration ── #}
{% if values.advanced.show_advanced %}
{% if values.advanced.auth_mode %}
{% do server.environment.add_env("HYTALE_AUTH_MODE", values.advanced.auth_mode) %}
{% endif %}
{% do server.environment.add_env("ENABLE_AOT", values.advanced.enable_aot) %}
{% do server.environment.add_env("HYTALE_DISABLE_SENTRY", values.advanced.disable_sentry) %}
{% do server.environment.add_env("DEBUG", values.advanced.debug) %}
{% if values.advanced.enable_backup %}
{% do server.environment.add_env("HYTALE_BACKUP", true) %}
{% do server.environment.add_env("HYTALE_BACKUP_FREQUENCY", values.advanced.backup_frequency) %}
{% do server.environment.add_env("HYTALE_BACKUP_MAX_COUNT", values.advanced.backup_max_count) %}
{% endif %}
{% do server.environment.add_env("WHITELIST_ENABLED", values.advanced.whitelist_enabled) %}
{% if values.advanced.whitelist_enabled and values.advanced.whitelist_list %}
{% do server.environment.add_env("WHITELIST_LIST", values.advanced.whitelist_list) %}
{% endif %}
{% do server.environment.add_env("SKIP_BROKEN_MODS", values.advanced.skip_broken_mods) %}
{% do server.environment.add_env("MAX_VIEW_RADIUS", values.advanced.max_view_radius) %}
{# Additional environment variables #}
{% for env in values.advanced.additional_envs %}
{% do server.environment.add_env(env.name, env.value) %}
{% endfor %}
{% endif %}

{# ── Ports ── #}
{% do server.add_port(values.network.game_port, {"protocol": "udp"}) %}
{% if values.api.enabled %}
{% do server.add_port(values.network.api_port) %}
{% endif %}

{# ── Storage ── #}
{% do server.add_storage(values.consts.data_path, values.storage.data) %}
{% for store in values.storage.additional_storage %}
{% do server.add_storage(store.mount_path, store) %}
{% endfor %}

{# ============================================================================ #}
{# HyOS Manager Container (Conditional) #}
{# ============================================================================ #}
{% if values.manager.enabled %}
{% set mgr = tpl.add_container(values.consts.manager_container_name, "manager_image") %}

{% do mgr.set_user(values.run_as.user, values.run_as.group) %}
{# Add to root group for Docker socket access #}
{% do mgr.add_group(0) %}

{# Manager environment variables (TZ auto-set by library) #}
{% do mgr.environment.add_env("NODE_ENV", "production") %}
{% do mgr.environment.add_env("ADAPTER_TYPE", "rest") %}
{% do mgr.environment.add_env("HYTALE_CONTAINER_NAME", values.consts.server_container_name) %}
{% do mgr.environment.add_env("HYTALE_STATE_DIR", "/data/.state") %}
{% do mgr.environment.add_env("HYTALE_SERVER_HOST", values.consts.server_container_name) %}
{% do mgr.environment.add_env("HYTALE_SERVER_PORT", values.network.api_port.port_number) %}
{% do mgr.environment.add_env("API_CLIENT_SECRET", values.api.client_secret) %}
{% do mgr.environment.add_env("API_CLIENT_ID", values.api.client_id) %}

{# Manager port #}
{% do mgr.add_port(values.network.manager_port) %}

{# Shared data storage for state file access #}
{% do mgr.add_storage(values.consts.data_path, values.storage.data) %}

{# Docker socket for container control #}
{% set docker_socket = {"type": "host_path", "host_path_config": {"path": "/var/run/docker.sock"}} %}
{% do mgr.add_storage("/var/run/docker.sock", docker_socket) %}

{# Health check for manager #}
{% do mgr.healthcheck.set_test("wget", {"port": 3000, "path": "/api/server/status"}) %}
{% do mgr.healthcheck.set_interval(30) %}
{% do mgr.healthcheck.set_timeout(10) %}
{% do mgr.healthcheck.set_start_period(60) %}
{% do mgr.healthcheck.set_retries(3) %}

{# Manager depends on server being started (no healthcheck on server) #}
{% do mgr.depends.add_dependency(values.consts.server_container_name, "service_started") %}

{# Add portal for manager web UI #}
{% do tpl.portals.add(values.network.manager_port, {"scheme": "http", "path": "/"}) %}
{% endif %}

{# ============================================================================ #}
{# Permissions Init Container #}
{# ============================================================================ #}
{% set perms = tpl.deps.perms(values.consts.perms_container_name) %}
{% do perms.add_or_skip_action("data", values.storage.data, {"uid": values.run_as.user, "gid": values.run_as.group, "mode": "check"}) %}
{% if perms.has_actions() %}
{% do perms.activate() %}
{% do server.depends.add_dependency(values.consts.perms_container_name, "service_completed_successfully") %}
{% endif %}

{# ============================================================================ #}
{# Render Final Output #}
{# ============================================================================ #}
{{ tpl.render() | tojson }}
