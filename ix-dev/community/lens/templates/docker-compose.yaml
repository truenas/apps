{% set tpl = ix_lib.base.render.Render(values) %}

{% set perm_container = tpl.deps.perms(values.consts.perms_container_name) %}
{% set perms_config = {"uid": values.run_as.user, "gid": values.run_as.group, "mode": "check"} %}

{# Init Container - Copies sample files from backend image to mounted volume #}
{# We use the backend image which contains the sample files, but mount the volume at a different path #}
{% set init = tpl.add_container(values.consts.init_container_name, "backend") %}
{% do init.set_user(values.run_as.user, values.run_as.group) %}
{% do init.setup_as_helper() %}
{% do init.add_storage("/mnt/uploads", values.storage.uploads_data) %}
{% do init.configs.add("init-script", "#!/bin/sh\nset -e\n\necho \"Initializing uploads directory...\"\n\n# Copy sample files from image (/app/uploads) to volume (/mnt/uploads) if volume is empty\nif [ -z \"$(ls -A /mnt/uploads 2>/dev/null)\" ] && [ -d /app/uploads ]; then\n  echo \"Copying sample files from image to volume...\"\n  cp -r /app/uploads/* /mnt/uploads/ 2>/dev/null || true\n  echo \"Sample files copied successfully\"\nelse\n  echo \"Uploads directory already contains files, skipping copy\"\nfi\n\necho \"Uploads directory initialized\"\n", "/init-script.sh", "0755") %}
{% do init.set_entrypoint(["/bin/sh", "/init-script.sh"]) %}

{# MongoDB Container #}
{% set mongodb = tpl.add_container(values.consts.mongodb_container_name, "mongodb") %}
{% do mongodb.set_user(568, 568) %}
{% do mongodb.healthcheck.set_test("mongodb", {"db": "backend-db", "port": 27017}) %}
{% if values.lens.expose_db_port %}
  {% do mongodb.add_port({"port_number": values.lens.expose_db_port, "bind_mode": "published", "container_port": 27017}) %}
{% endif %}
{% do mongodb.add_storage("/data/db", values.storage.mongodb_data) %}
{% do perm_container.add_or_skip_action("mongodb_data", values.storage.mongodb_data, {"uid": 568, "gid": 568, "mode": "check"}) %}

{# Redis Container #}
{% set redis = tpl.add_container(values.consts.fc_worker_redis_container_name, "redis") %}
{% do redis.set_user(values.run_as.user, values.run_as.group) %}
{% do redis.healthcheck.set_test("redis", {"port": 6379}) %}

{# Backend Container #}
{% set backend = tpl.add_container(values.consts.backend_container_name, "backend") %}
{% do backend.set_user(values.run_as.user, values.run_as.group) %}
{% do backend.depends.add_dependency(values.consts.mongodb_container_name, "service_healthy") %}
{% do backend.depends.add_dependency(values.consts.init_container_name, "service_completed_successfully") %}
{% do backend.add_port({"port_number": values.lens.port, "bind_mode": "published", "container_port": values.lens.port}) %}
{% do backend.healthcheck.set_test("wget", {"port": values.lens.port, "path": "/"}) %}

{% do backend.environment.add_env("HOSTNAME", values.lens.hostname) %}
{% do backend.environment.add_env("PORT", values.lens.port) %}
{% do backend.environment.add_env("DB_URL", "mongodb://%s:27017/backend-db" | format(values.consts.mongodb_container_name)) %}
{% do backend.environment.add_env("FRONTEND_URL", values.lens.frontend_url) %}
{% do backend.environment.add_env("FC_WORKER_URL", "http://0.0.0.0:8080/2015-03-31/functions/function/invocations") %}

{% if values.lens.smtp_host %}
  {% do backend.environment.add_env("SMTP_HOST", values.lens.smtp_host) %}
{% endif %}
{% if values.lens.smtp_port %}
  {% do backend.environment.add_env("SMTP_PORT", values.lens.smtp_port) %}
{% endif %}
{% if values.lens.smtp_user %}
  {% do backend.environment.add_env("SMTP_USER", values.lens.smtp_user) %}
{% endif %}
{% if values.lens.smtp_pass %}
  {% do backend.environment.add_env("SMTP_PASS", values.lens.smtp_pass) %}
{% endif %}
{% if values.lens.smtp_from %}
  {% do backend.environment.add_env("SMTP_FROM", values.lens.smtp_from) %}
{% endif %}

{% do backend.environment.add_env("DEFAULT_ADMIN_EMAIL", values.lens.default_admin_email) %}
{% do backend.environment.add_env("DEFAULT_ADMIN_USERNAME", values.lens.default_admin_username) %}
{% do backend.environment.add_env("DEFAULT_ADMIN_PASSWORD", values.lens.default_admin_password) %}
{% do backend.environment.add_env("DEFAULT_ADMIN_NAME", values.lens.default_admin_name) %}

{% if values.lens.local_signed_url_secret %}
  {% do backend.environment.add_env("LOCAL_SIGNED_URL_SECRET", values.lens.local_signed_url_secret) %}
{% endif %}

{% do backend.add_storage("/app/uploads", values.storage.uploads_data) %}
{% do perm_container.add_or_skip_action("uploads_data", values.storage.uploads_data, perms_config) %}

{# Frontend Container #}
{% set frontend = tpl.add_container(values.consts.frontend_container_name, "frontend") %}
{% do frontend.set_user(values.run_as.user, values.run_as.group) %}
{% do frontend.add_caps(["CHOWN", "SETUID", "SETGID"]) %}
{% do frontend.depends.add_dependency(values.consts.backend_container_name, "service_healthy") %}
{% do frontend.add_port({"port_number": values.lens.frontend_port, "bind_mode": "published", "container_port": 80}) %}
{% do frontend.healthcheck.set_test("http", {"port": 80, "path": "/"}) %}

{% if values.lens.vite_app_api_url %}
  {% set api_url = values.lens.vite_app_api_url %}
  {% if api_url[-1:] != '/' %}
    {% set api_url = api_url + '/' %}
  {% endif %}
  {% do frontend.environment.add_env("VITE_APP_API_URL", api_url) %}
{% else %}
  {% do frontend.environment.add_env("VITE_APP_API_URL", "http://%s:%d/" | format(values.lens.hostname, values.lens.port)) %}
{% endif %}

{% if values.lens.vite_stripe_purchase_peer_url %}
  {% do frontend.environment.add_env("VITE_STRIPE_PURCHASE_PEER_URL", values.lens.vite_stripe_purchase_peer_url) %}
{% endif %}

{% do frontend.environment.add_env("PROXY_SCHEME_PREFIX", "http://") %}

{# FC Worker API Container #}
{% set fc_worker_api = tpl.add_container(values.consts.fc_worker_api_container_name, "fc_worker_api") %}
{% do fc_worker_api.set_user(values.run_as.user, values.run_as.group) %}
{% do fc_worker_api.set_network_mode("service:%s" | format(values.consts.backend_container_name)) %}
{% do fc_worker_api.depends.add_dependency(values.consts.backend_container_name, "service_healthy") %}
{% do fc_worker_api.depends.add_dependency(values.consts.fc_worker_redis_container_name, "service_healthy") %}
{% do fc_worker_api.healthcheck.set_custom_test("echo 'OK'") %}

{% do fc_worker_api.environment.add_env("REDIS_HOST", values.consts.fc_worker_redis_container_name) %}
{% do fc_worker_api.environment.add_env("REDIS_PORT", "6379") %}

{# FC Worker Celery Container #}
{% set fc_worker_celery = tpl.add_container(values.consts.fc_worker_celery_container_name, "fc_worker_celery") %}
{% do fc_worker_celery.set_user(values.run_as.user, values.run_as.group) %}
{% do fc_worker_celery.set_network_mode("service:%s" | format(values.consts.backend_container_name)) %}
{% do fc_worker_celery.depends.add_dependency(values.consts.backend_container_name, "service_healthy") %}
{% do fc_worker_celery.depends.add_dependency(values.consts.fc_worker_redis_container_name, "service_healthy") %}
{% do fc_worker_celery.healthcheck.set_custom_test("echo 'OK'") %}

{% do fc_worker_celery.environment.add_env("REDIS_HOST", values.consts.fc_worker_redis_container_name) %}
{% do fc_worker_celery.environment.add_env("REDIS_PORT", "6379") %}
{% do fc_worker_celery.environment.add_env("BACKEND_URL", "http://%s:%d" | format(values.consts.backend_container_name, values.lens.port)) %}

{# Permissions Container #}
{% if perm_container.has_actions() %}
  {% do perm_container.activate() %}
  {% do mongodb.depends.add_dependency(values.consts.perms_container_name, "service_completed_successfully") %}
  {% do backend.depends.add_dependency(values.consts.perms_container_name, "service_completed_successfully") %}
  {% do init.depends.add_dependency(values.consts.perms_container_name, "service_completed_successfully") %}
{% endif %}

{# Portals #}
{% do tpl.portals.add({"port_number": values.lens.port, "bind_mode": "published"}, {"name": "Backend API"}) %}
{% do tpl.portals.add({"port_number": values.lens.frontend_port, "bind_mode": "published"}, {"name": "Frontend"}) %}

{{ tpl.render() | tojson }}
