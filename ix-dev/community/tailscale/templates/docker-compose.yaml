{% set tpl = ix_lib.base.render.Render(values) %}

{% set c1 = tpl.add_container(values.consts.tailscale_container_name, "image") %}
{% set perm_container = tpl.deps.perms(values.consts.perms_container_name) %}
{% set perm_config = {"uid": 568, "gid": 568, "mode": "check"} %}

{% do c1.add_caps(["NET_ADMIN", "NET_RAW", "SYS_MODULE", "CHOWN", "FOWNER", "DAC_OVERRIDE"]) %}
{% do c1.healthcheck.set_custom_test(["CMD", "tailscale", "status"]) %}

{% set args = namespace(x=[]) %}
{% set arg_map = {
  "advertise_exit_node": "--advertise-exit-node",
  "reset": "--reset",
  "accept_routes": "--accept-routes",
} %}

{% for key, value in arg_map.items() %}
  {% if values.tailscale[key] %}
    {% do args.x.append(value) %}
  {% endif %}
{% endfor %}

{% do tpl.funcs.require_no_reserved(values.tailscale.extra_args, "Extra Arguments", values.consts.reserved_keys, starts_with=true) %}

{% for arg in values.tailscale.extra_args %}
  {% do args.x.append(arg) %}
{% endfor %}

{% do c1.environment.add_env("TS_STATE_DIR", values.consts.state_path) %}
{% do c1.environment.add_env("TS_ACCEPT_DNS", values.tailscale.accept_dns) %}
{% do c1.environment.add_env("TS_HOSTNAME", values.tailscale.hostname) %}
{% do c1.environment.add_env("TS_USERSPACE", values.tailscale.userspace) %}
{% do c1.environment.add_env("TS_AUTH_ONCE", values.tailscale.auth_once) %}
{% do c1.environment.add_env("TS_AUTHKEY", values.tailscale.auth_key) %}
{% do c1.environment.add_env("TS_SOCKET", "/var/run/tailscale/tailscaled.sock") %}
{% if values.tailscale.tailscaled_args %}
  {% do c1.environment.add_env("TS_TAILSCALED_EXTRA_ARGS", values.tailscale.tailscaled_args|unique|list|join(" ")) %}
{% endif %}
{% if values.tailscale.advertise_routes %}
  {% do c1.environment.add_env("TS_ROUTES", values.tailscale.advertise_routes|unique|list|join(",")) %}
{% endif %}

{% if args.x %}
  {% do c1.environment.add_env("TS_EXTRA_ARGS", args.x|join(" ")) %}
{% endif %}

{% do c1.environment.add_user_envs(values.tailscale.additional_envs) %}

{% if values.tailscale.serve.enabled and values.tailscale.serve.services %}
  {% set serve_config_path = "%s/%s"|format(values.consts.serve_config_dir, values.consts.serve_config_filename) %}
  {% do c1.environment.add_env("TS_SERVE_CONFIG", serve_config_path) %}

  {# Build JSON from services list #}
  {% set tcp_config = {} %}
  {% set web_config = {} %}
  {% set funnel_config = {} %}

  {% for svc in values.tailscale.serve.services %}
    {% if svc.protocol == "https" %}
      {# HTTPS Proxy mode - TLS termination with HTTP proxy #}
      {% do tcp_config.update({svc.port|string: {"HTTPS": true}}) %}

      {% set domain_key = "${TS_CERT_DOMAIN}:%d"|format(svc.port) %}
      {% if domain_key not in web_config %}
        {% do web_config.update({domain_key: {"Handlers": {}}}) %}
      {% endif %}
      {% do web_config[domain_key]["Handlers"].update({svc.path_prefix: {"Proxy": svc.proxy_target}}) %}

      {% if values.tailscale.serve.funnel %}
        {% do funnel_config.update({svc.port|string: true}) %}
      {% endif %}
    {% elif svc.protocol == "tcp" %}
      {# TCP Passthrough mode - raw TCP forwarding #}
      {% do tcp_config.update({svc.port|string: {"TCP": true}}) %}

      {% set domain_key = "${TS_CERT_DOMAIN}:%d"|format(svc.port) %}
      {% do web_config.update({domain_key: {"TCPForward": svc.tcp_target}}) %}
    {% endif %}
  {% endfor %}

  {% set serve_json = {"TCP": tcp_config, "Web": web_config} %}
  {% if funnel_config %}
    {% do serve_json.update({"AllowFunnel": funnel_config}) %}
  {% endif %}

  {% do c1.configs.add("serve-config", serve_json|tojson, serve_config_path) %}
{% endif %}

{% if not values.tailscale.userspace %}
  {% do c1.add_tun_device() %}
{% endif %}

{% do c1.add_storage("/var/run/tailscale", {"type":"tmpfs", "tmpfs_config": {"mode": "0755"}}) %}

{% do c1.add_storage(values.consts.state_path, values.storage.state) %}
{% if values.tailscale.userspace %}
  {% do perm_container.add_or_skip_action("state", values.storage.state, perm_config) %}
{% endif %}

{% for store in values.storage.additional_storage %}
  {% do c1.add_storage(store.mount_path, store) %}
  {% if values.tailscale.userspace %}
    {% do perm_container.add_or_skip_action(store.mount_path, store, perm_config) %}
  {% endif %}
{% endfor %}

{% if perm_container.has_actions() %}
  {% do perm_container.activate() %}
  {% do c1.depends.add_dependency(values.consts.perms_container_name, "service_completed_successfully") %}
{% endif %}

{{ tpl.render() | tojson }}
