#!/usr/bin/python3

import os
import sys
import yaml
import secrets
import base64


def migrate(values):
    # Generate share_token_secret if it doesn't exist (base64, 64 bytes = ~86 chars base64)
    if "share_token_secret" not in values.get("vitransfer", {}):
        # Generate 64 random bytes and encode as base64 (similar to openssl rand -base64 64)
        random_bytes = secrets.token_bytes(64)
        values["vitransfer"]["share_token_secret"] = base64.b64encode(random_bytes).decode('utf-8')

    # Add admin_name with default if it doesn't exist
    if "admin_name" not in values.get("vitransfer", {}):
        values["vitransfer"]["admin_name"] = "Admin"

    return values


if __name__ == "__main__":
    if len(sys.argv) != 2:
        exit(1)

    if os.path.exists(sys.argv[1]):
        with open(sys.argv[1], "r") as f:
            print(yaml.dump(migrate(yaml.safe_load(f.read()))))
