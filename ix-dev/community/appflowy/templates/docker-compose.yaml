{% set tpl = ix_lib.base.render.Render(values) %}

{% if values.appflowy.web_host.startswith("https://") or values.appflowy.web_host.startswith("http://") %}
  {% do tpl.funcs.fail("Expected [appflowy.web_host] to not start with [http(s)://]") %}
{% endif %}
{% if values.appflowy.web_host.endswith("/") %}
  {% do tpl.funcs.fail("Expected [appflowy.web_host] to not end with [/]") %}
{% endif %}
{% if ":" in values.appflowy.web_host %}
  {% do tpl.funcs.fail("Expected [appflowy.web_host] to not contain port [:###]") %}
{% endif %}

{% set perm_container = tpl.deps.perms(values.consts.perms_container_name) %}

{% set pg_config = {
  "user": values.consts.db_user,
  "password": values.database.postgres_password,
  "database": values.consts.db_name,
  "volume": values.storage.postgres_data,
} %}
{% set postgres = tpl.deps.postgres(values.consts.postgres_container_name, "postgres_image", pg_config, perm_container) %}

{% set proto = "https" if values.network.certificate_id else "http" %}
{% set base_url = proto ~ "://" ~ values.appflowy.web_host %}

{# Redis container #}
{% set redis = tpl.add_container(values.consts.redis_container_name, "redis_image") %}
{% do redis.set_user(values.run_as.user, values.run_as.group) %}
{% do redis.healthcheck.set_test("redis", {"password": ""}) %}

{# MinIO container (only when not using external S3) #}
{% if not values.s3.use_external_s3 %}
  {% set minio = tpl.add_container(values.consts.minio_container_name, "minio_image") %}
  {% do minio.set_command(["server", "/data", "--console-address", ":9001"]) %}
  {% do minio.environment.add_env("MINIO_BROWSER_REDIRECT_URL", base_url ~ "/minio") %}
  {% do minio.environment.add_env("MINIO_ROOT_USER", values.s3.access_key) %}
  {% do minio.environment.add_env("MINIO_ROOT_PASSWORD", values.s3.secret_key) %}
  {% do minio.healthcheck.disable() %}

  {% set perms_config = {"uid": values.run_as.user, "gid": values.run_as.group, "mode": "check"} %}
  {% do minio.add_storage("/data", values.storage.minio_data) %}
  {% do perm_container.add_or_skip_action("minio_data", values.storage.minio_data, perms_config) %}
{% endif %}

{# GoTrue container #}
{% set gotrue = tpl.add_container(values.consts.gotrue_container_name, "gotrue_image") %}
{% do gotrue.depends.add_dependency(values.consts.postgres_container_name, "service_healthy") %}
{% do gotrue.healthcheck.set_test("curl", {"port": 9999, "path": "/health"}) %}

{% set gotrue_db_url = "postgres://" ~ values.consts.db_user ~ ":" ~ values.database.postgres_password ~ "@" ~ values.consts.postgres_container_name ~ ":5432/" ~ values.consts.db_name ~ "?search_path=auth,public" %}

{% do gotrue.environment.add_env("GOTRUE_ADMIN_EMAIL", values.auth.gotrue_admin_email) %}
{% do gotrue.environment.add_env("GOTRUE_ADMIN_PASSWORD", values.auth.gotrue_admin_password) %}
{% do gotrue.environment.add_env("GOTRUE_DISABLE_SIGNUP", values.auth.disable_signup) %}
{% do gotrue.environment.add_env("GOTRUE_SITE_URL", "appflowy-flutter://") %}
{% do gotrue.environment.add_env("GOTRUE_URI_ALLOW_LIST", "**") %}
{% do gotrue.environment.add_env("GOTRUE_JWT_SECRET", values.auth.gotrue_jwt_secret) %}
{% do gotrue.environment.add_env("GOTRUE_JWT_EXP", values.auth.gotrue_jwt_exp) %}
{% do gotrue.environment.add_env("GOTRUE_JWT_ADMIN_GROUP_NAME", "supabase_admin") %}
{% do gotrue.environment.add_env("GOTRUE_DB_DRIVER", "postgres") %}
{% do gotrue.environment.add_env("GOTRUE_DB_NAMESPACE", "auth") %}
{% do gotrue.environment.add_env("API_EXTERNAL_URL", base_url) %}
{% do gotrue.environment.add_env("DATABASE_URL", gotrue_db_url) %}
{% do gotrue.environment.add_env("PORT", 9999) %}

{% if values.email.smtp_host %}
  {% do gotrue.environment.add_env("GOTRUE_SMTP_HOST", values.email.smtp_host) %}
  {% do gotrue.environment.add_env("GOTRUE_SMTP_PORT", values.email.smtp_port) %}
  {% do gotrue.environment.add_env("GOTRUE_SMTP_USER", values.email.smtp_user) %}
  {% do gotrue.environment.add_env("GOTRUE_SMTP_PASS", values.email.smtp_password) %}
  {% do gotrue.environment.add_env("GOTRUE_MAILER_URLPATHS_CONFIRMATION", "/gotrue/verify") %}
  {% do gotrue.environment.add_env("GOTRUE_MAILER_URLPATHS_INVITE", "/gotrue/verify") %}
  {% do gotrue.environment.add_env("GOTRUE_MAILER_URLPATHS_RECOVERY", "/gotrue/verify") %}
  {% do gotrue.environment.add_env("GOTRUE_MAILER_URLPATHS_EMAIL_CHANGE", "/gotrue/verify") %}
  {% do gotrue.environment.add_env("GOTRUE_SMTP_ADMIN_EMAIL", values.email.smtp_email) %}
{% endif %}

{# AppFlowy Cloud container #}
{% set appflowy_cloud = tpl.add_container(values.consts.appflowy_cloud_container_name, "appflowy_cloud_image") %}
{% do appflowy_cloud.depends.add_dependency(values.consts.gotrue_container_name, "service_healthy") %}
{% do appflowy_cloud.healthcheck.set_test("tcp", {"port": 8000}) %}

{% set appflowy_db_url = "postgres://" ~ values.consts.db_user ~ ":" ~ values.database.postgres_password ~ "@" ~ values.consts.postgres_container_name ~ ":5432/" ~ values.consts.db_name %}
{% set redis_url = "redis://" ~ values.consts.redis_container_name ~ ":6379" %}

{% do appflowy_cloud.environment.add_env("RUST_LOG", "info") %}
{% do appflowy_cloud.environment.add_env("APPFLOWY_ENVIRONMENT", "production") %}
{% do appflowy_cloud.environment.add_env("APPFLOWY_DATABASE_URL", appflowy_db_url) %}
{% do appflowy_cloud.environment.add_env("APPFLOWY_REDIS_URI", redis_url) %}
{% do appflowy_cloud.environment.add_env("APPFLOWY_GOTRUE_JWT_SECRET", values.auth.gotrue_jwt_secret) %}
{% do appflowy_cloud.environment.add_env("APPFLOWY_GOTRUE_JWT_EXP", values.auth.gotrue_jwt_exp) %}
{% do appflowy_cloud.environment.add_env("APPFLOWY_GOTRUE_BASE_URL", base_url ~ "/gotrue") %}
{% if values.s3.use_external_s3 %}
  {% do appflowy_cloud.environment.add_env("APPFLOWY_S3_CREATE_BUCKET", "false") %}
  {% do appflowy_cloud.environment.add_env("APPFLOWY_S3_USE_MINIO", "false") %}
  {% do appflowy_cloud.environment.add_env("APPFLOWY_S3_ACCESS_KEY", values.s3.access_key) %}
  {% do appflowy_cloud.environment.add_env("APPFLOWY_S3_SECRET_KEY", values.s3.secret_key) %}
  {% do appflowy_cloud.environment.add_env("APPFLOWY_S3_BUCKET", values.s3.bucket_name) %}
  {% do appflowy_cloud.environment.add_env("APPFLOWY_S3_REGION", "us-east-1") %}
  {% if values.s3.endpoint %}
    {% do appflowy_cloud.environment.add_env("APPFLOWY_S3_PRESIGNED_URL_ENDPOINT", values.s3.endpoint) %}
  {% endif %}
{% else %}
  {% do appflowy_cloud.environment.add_env("APPFLOWY_S3_CREATE_BUCKET", "true") %}
  {% do appflowy_cloud.environment.add_env("APPFLOWY_S3_USE_MINIO", "true") %}
  {% do appflowy_cloud.environment.add_env("APPFLOWY_S3_MINIO_URL", "http://" ~ values.consts.minio_container_name ~ ":9000") %}
  {% do appflowy_cloud.environment.add_env("APPFLOWY_S3_ACCESS_KEY", values.s3.access_key) %}
  {% do appflowy_cloud.environment.add_env("APPFLOWY_S3_SECRET_KEY", values.s3.secret_key) %}
  {% do appflowy_cloud.environment.add_env("APPFLOWY_S3_BUCKET", values.s3.bucket_name) %}
  {% do appflowy_cloud.environment.add_env("APPFLOWY_S3_REGION", "us-east-1") %}
  {% do appflowy_cloud.environment.add_env("APPFLOWY_S3_PRESIGNED_URL_ENDPOINT", base_url ~ "/minio-api") %}
{% endif %}
{% do appflowy_cloud.environment.add_env("APPFLOWY_WEB_URL", base_url) %}
{% do appflowy_cloud.environment.add_env("APPFLOWY_DATABASE_MAX_CONNECTIONS", "40") %}

{% if values.ai.enable_ai and values.ai.openai_api_key %}
  {% do appflowy_cloud.environment.add_env("AI_SERVER_HOST", values.consts.appflowy_ai_container_name) %}
  {% do appflowy_cloud.environment.add_env("AI_SERVER_PORT", "5001") %}
  {% do appflowy_cloud.environment.add_env("AI_OPENAI_API_KEY", values.ai.openai_api_key) %}
{% endif %}

{% if values.email.smtp_host %}
  {% do appflowy_cloud.environment.add_env("APPFLOWY_MAILER_SMTP_HOST", values.email.smtp_host) %}
  {% do appflowy_cloud.environment.add_env("APPFLOWY_MAILER_SMTP_PORT", values.email.smtp_port) %}
  {% do appflowy_cloud.environment.add_env("APPFLOWY_MAILER_SMTP_USERNAME", values.email.smtp_user) %}
  {% do appflowy_cloud.environment.add_env("APPFLOWY_MAILER_SMTP_EMAIL", values.email.smtp_email) %}
  {% do appflowy_cloud.environment.add_env("APPFLOWY_MAILER_SMTP_PASSWORD", values.email.smtp_password) %}
  {% do appflowy_cloud.environment.add_env("APPFLOWY_MAILER_SMTP_TLS_KIND", "starttls") %}
{% endif %}

{# Admin Frontend container (optional) #}
{% if values.appflowy.enable_admin_console %}
  {% set admin_frontend = tpl.add_container(values.consts.admin_frontend_container_name, "admin_frontend_image") %}
  {% do admin_frontend.depends.add_dependency(values.consts.gotrue_container_name, "service_healthy") %}
  {% do admin_frontend.depends.add_dependency(values.consts.appflowy_cloud_container_name, "service_started") %}
  {% do admin_frontend.healthcheck.set_test("tcp", {"port": 3000}) %}

  {% do admin_frontend.environment.add_env("RUST_LOG", "info") %}
  {% do admin_frontend.environment.add_env("ADMIN_FRONTEND_REDIS_URL", redis_url) %}
  {% do admin_frontend.environment.add_env("ADMIN_FRONTEND_GOTRUE_URL", "http://" ~ values.consts.gotrue_container_name ~ ":9999") %}
  {% do admin_frontend.environment.add_env("ADMIN_FRONTEND_APPFLOWY_CLOUD_URL", "http://" ~ values.consts.appflowy_cloud_container_name ~ ":8000") %}
{% endif %}

{# AI container (optional) #}
{% if values.ai.enable_ai and values.ai.openai_api_key %}
  {% set ai = tpl.add_container(values.consts.appflowy_ai_container_name, "appflowy_ai_image") %}
  {% do ai.depends.add_dependency(values.consts.postgres_container_name, "service_healthy") %}
  {% do ai.depends.add_dependency(values.consts.appflowy_cloud_container_name, "service_started") %}
  {% do ai.healthcheck.set_test("tcp", {"port": 5001}) %}

  {% do ai.environment.add_env("AI_SERVER_PORT", "5001") %}
  {% do ai.environment.add_env("OPENAI_API_KEY", values.ai.openai_api_key) %}
  {% do ai.environment.add_env("DEFAULT_AI_MODEL", "gpt-4.1-mini") %}
  {% do ai.environment.add_env("DEFAULT_AI_COMPLETION_MODEL", "gpt-4.1-mini") %}
  {% do ai.environment.add_env("APPFLOWY_S3_ACCESS_KEY", values.s3.access_key) %}
  {% do ai.environment.add_env("APPFLOWY_S3_SECRET_KEY", values.s3.secret_key) %}
  {% do ai.environment.add_env("APPFLOWY_S3_BUCKET", values.s3.bucket_name) %}
  {% do ai.environment.add_env("APPFLOWY_S3_REGION", "us-east-1") %}
  {% do ai.environment.add_env("AI_DATABASE_URL", appflowy_db_url) %}
  {% do ai.environment.add_env("AI_REDIS_URL", redis_url) %}
  {% do ai.environment.add_env("AI_USE_MINIO", "true") %}
  {% do ai.environment.add_env("AI_MINIO_URL", "http://" ~ values.consts.minio_container_name ~ ":9000") %}
  {% do ai.environment.add_env("AI_APPFLOWY_HOST", base_url) %}
  {% do ai.environment.add_env("APPFLOWY_GOTRUE_JWT_SECRET", values.auth.gotrue_jwt_secret) %}
{% endif %}

{# Worker container #}
{% set worker = tpl.add_container(values.consts.appflowy_worker_container_name, "appflowy_worker_image") %}
{% do worker.depends.add_dependency(values.consts.postgres_container_name, "service_healthy") %}
{% do worker.healthcheck.use_built_in() %}

{% set worker_db_url = "postgres://" ~ values.consts.db_user ~ ":" ~ values.database.postgres_password ~ "@" ~ values.consts.postgres_container_name ~ ":5432/" ~ values.consts.db_name %}

{% do worker.environment.add_env("RUST_LOG", "info") %}
{% do worker.environment.add_env("APPFLOWY_ENVIRONMENT", "production") %}
{% do worker.environment.add_env("APPFLOWY_WORKER_REDIS_URL", redis_url) %}
{% do worker.environment.add_env("APPFLOWY_WORKER_ENVIRONMENT", "production") %}
{% do worker.environment.add_env("APPFLOWY_WORKER_DATABASE_URL", worker_db_url) %}
{% do worker.environment.add_env("APPFLOWY_WORKER_DATABASE_NAME", values.consts.db_name) %}
{% do worker.environment.add_env("APPFLOWY_WORKER_IMPORT_TICK_INTERVAL", "30") %}
{% if values.s3.use_external_s3 %}
  {% do worker.environment.add_env("APPFLOWY_S3_USE_MINIO", "false") %}
  {% do worker.environment.add_env("APPFLOWY_S3_ACCESS_KEY", values.s3.access_key) %}
  {% do worker.environment.add_env("APPFLOWY_S3_SECRET_KEY", values.s3.secret_key) %}
  {% do worker.environment.add_env("APPFLOWY_S3_BUCKET", values.s3.bucket_name) %}
  {% do worker.environment.add_env("APPFLOWY_S3_REGION", "us-east-1") %}
{% else %}
  {% do worker.environment.add_env("APPFLOWY_S3_USE_MINIO", "true") %}
  {% do worker.environment.add_env("APPFLOWY_S3_MINIO_URL", "http://" ~ values.consts.minio_container_name ~ ":9000") %}
  {% do worker.environment.add_env("APPFLOWY_S3_ACCESS_KEY", values.s3.access_key) %}
  {% do worker.environment.add_env("APPFLOWY_S3_SECRET_KEY", values.s3.secret_key) %}
  {% do worker.environment.add_env("APPFLOWY_S3_BUCKET", values.s3.bucket_name) %}
  {% do worker.environment.add_env("APPFLOWY_S3_REGION", "us-east-1") %}
{% endif %}

{% if values.email.smtp_host %}
  {% do worker.environment.add_env("APPFLOWY_MAILER_SMTP_HOST", values.email.smtp_host) %}
  {% do worker.environment.add_env("APPFLOWY_MAILER_SMTP_PORT", values.email.smtp_port) %}
  {% do worker.environment.add_env("APPFLOWY_MAILER_SMTP_USERNAME", values.email.smtp_user) %}
  {% do worker.environment.add_env("APPFLOWY_MAILER_SMTP_EMAIL", values.email.smtp_email) %}
  {% do worker.environment.add_env("APPFLOWY_MAILER_SMTP_PASSWORD", values.email.smtp_password) %}
  {% do worker.environment.add_env("APPFLOWY_MAILER_SMTP_TLS_KIND", "starttls") %}
{% endif %}

{# Web container #}
{% set web = tpl.add_container(values.consts.appflowy_web_container_name, "appflowy_web_image") %}
{% do web.depends.add_dependency(values.consts.appflowy_cloud_container_name, "service_started") %}
{% do web.healthcheck.disable() %}
{% do web.add_caps(["CHOWN", "SETGID", "SETUID"]) %}

{% set ws_base_url = "ws" ~ (proto | replace("http", "")) ~ "://" ~ values.appflowy.web_host %}
{% do web.environment.add_env("APPFLOWY_BASE_URL", base_url) %}
{% do web.environment.add_env("APPFLOWY_GOTRUE_BASE_URL", base_url ~ "/gotrue") %}
{% do web.environment.add_env("APPFLOWY_WS_BASE_URL", ws_base_url) %}

{# Nginx container #}
{% set nginx = tpl.add_container(values.consts.nginx_container_name, "nginx_image") %}
{% do nginx.depends.add_dependency(values.consts.appflowy_cloud_container_name, "service_started") %}
{% do nginx.depends.add_dependency(values.consts.gotrue_container_name, "service_healthy") %}
{% do nginx.healthcheck.set_test("tcp", {"port": 80}) %}
{% do nginx.add_caps(["CHOWN", "SETGID", "SETUID"]) %}

{# Create simple nginx configuration #}
{% set nginx_config %}
events {
    worker_connections 1024;
}

http {
    resolver 127.0.0.11 valid=10s;

    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    server {
        listen 80;
{% if values.network.certificate_id %}
        listen 443 ssl;
        ssl_certificate {{ values.consts.ssl_cert_path }};
        ssl_certificate_key {{ values.consts.ssl_key_path }};
{% endif %}
        client_max_body_size 10M;
        underscores_in_headers on;

        # GoTrue
        location /gotrue/ {
            proxy_pass http://{{ values.consts.gotrue_container_name }}:9999;
            rewrite ^/gotrue(/.*)$ $1 break;
            proxy_set_header Host $http_host;
            proxy_pass_request_headers on;
        }

        # WebSocket
        location /ws {
            proxy_pass http://{{ values.consts.appflowy_cloud_container_name }}:8000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 86400s;
        }

        location /api {
            proxy_pass http://{{ values.consts.appflowy_cloud_container_name }}:8000;
            proxy_set_header X-Request-Id $request_id;
            proxy_set_header Host $http_host;
        }

        {% if not values.s3.use_external_s3 %}
        # Minio Web UI
        location /minio/ {
            proxy_pass http://{{ values.consts.minio_container_name }}:9001;
            rewrite ^/minio/(.*) /$1 break;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 300s;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
        {% endif %}

        {% if values.appflowy.enable_admin_console %}
        # Admin Frontend
        location /console {
            proxy_pass http://{{ values.consts.admin_frontend_container_name }}:3000;
            proxy_set_header X-Scheme $scheme;
            proxy_set_header Host $host;
        }
        {% endif %}

        # AppFlowy Web
        location / {
            proxy_pass http://{{ values.consts.appflowy_web_container_name }}:80;
            proxy_set_header X-Scheme $scheme;
            proxy_set_header Host $host;
        }
    }
}
{% endset %}

{% do nginx.configs.add("nginx_config", nginx_config, values.consts.nginx_config_path) %}

{% if values.network.certificate_id %}
  {% set cert = values.ix_certificates[values.network.certificate_id] %}
  {% do nginx.configs.add("ssl_cert", cert.certificate, values.consts.ssl_cert_path) %}
  {% do nginx.configs.add("ssl_key", cert.privatekey, values.consts.ssl_key_path) %}
{% endif %}

{# Add user environment variables #}
{% do appflowy_cloud.environment.add_user_envs(values.appflowy.additional_envs) %}

{# Add port mapping #}
{% do nginx.add_port(values.network.web_port) %}

{# Set up permissions dependencies #}
{% if perm_container.has_actions() %}
  {% do perm_container.activate() %}
  {% do nginx.depends.add_dependency(values.consts.perms_container_name, "service_completed_successfully") %}
  {% do redis.depends.add_dependency(values.consts.perms_container_name, "service_completed_successfully") %}
  {% if not values.s3.use_external_s3 %}
    {% do minio.depends.add_dependency(values.consts.perms_container_name, "service_completed_successfully") %}
  {% endif %}
  {% do gotrue.depends.add_dependency(values.consts.perms_container_name, "service_completed_successfully") %}
  {% do appflowy_cloud.depends.add_dependency(values.consts.perms_container_name, "service_completed_successfully") %}
  {% if values.appflowy.enable_admin_console %}
    {% do admin_frontend.depends.add_dependency(values.consts.perms_container_name, "service_completed_successfully") %}
  {% endif %}
  {% do worker.depends.add_dependency(values.consts.perms_container_name, "service_completed_successfully") %}
  {% do web.depends.add_dependency(values.consts.perms_container_name, "service_completed_successfully") %}
  {% do postgres.add_dependency(values.consts.perms_container_name, "service_completed_successfully") %}
  {% if values.ai.enable_ai and values.ai.openai_api_key %}
    {% do ai.depends.add_dependency(values.consts.perms_container_name, "service_completed_successfully") %}
  {% endif %}
{% endif %}

{# Add portal #}
{% do tpl.portals.add(values.network.web_port, {"scheme": proto}) %}

{{ tpl.render() | tojson }}
